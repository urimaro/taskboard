<html>
	<head>
		<meta charset="utf-8">
		<link rel="stylesheet" href="style.css" type="text/css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react-dom.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
		<script type="text/babel">
		// 付箋要素生成
		var Task = React.createClass({
			render: function() {
				return (
					<div>
						{this.props.dataTaskTitle}
						{this.props.children}
					</div>
				);
			}
		});

		// リスト生成
		var TaskList = React.createClass({
			componentDidMount: function(){
				this.fetchData();
			},
			getInitialState: function(){
				return {
					datas: []
				};
			},
			fetchData: function(){
				fetch(this.props.dataPass)
				.then((response) => response.json())
				.then((responseData) => {
					this.setState({
						datas: responseData
					});
				})
			},
			deleteData(e){
				var id  = e.currentTarget.getAttribute('id');
				fetch('/tasks/' + id, {method: 'DELETE'})
				.then((responseData) => {
					this.setState({
						datas: this.state.datas.filter((data) => {
							return data.id != id;
						})
					});
				})
			},
			createData: function(card_data){
				var datas = this.state.datas;
		    datas.push(card_data['card_data']);
		    this.setState(datas);
			},
			render: function() {
				let card_create_form = null;
				if (this.props.dataType=="Todo") {
					card_create_form = <CardCreateForm dataType={this.props.dataType} onEventCallBack={this.createData}/>
				}

				return (
					<div>
						<h1>{this.props.dataType}</h1>
						<div className="postit">
							{this.state.datas.map((data) => {
								return (
									<Task dataTaskTitle={data.title}>
										<input id={data.id} type="button" value="delete" onClick={this.deleteData}/>
									</Task>
								)
							})}
						</div>
						{card_create_form}
					</div>
				);
			}
    });

		var CardCreateForm = React.createClass({
			getInitialState: function(){
				return {
					title: ""
				};
			},
			changeTitle(e) {
				this.setState({title: e.target.value});
			},
			sendCard(event) {
				event.target.title.value="";
				fetch('/tasks', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						title: this.state.title,
						status: this.props.dataType,
					})
				}).then((response) => response.json())
				.then((responseData) => {
					this.props.onEventCallBack({ card_data : responseData });
				})
			},
			render: function() {
				return (
					<form action="javascript:void(0)" onSubmit={this.sendCard}>
						<div>{this.state.title}</div>
						<input type="text" placeholder="内容" name="title" onChange={this.changeTitle} required/>
						<input type="submit" value="追加"/>
					</form>
				);
			}
		});

		ReactDOM.render(<TaskList dataPass="todo"  dataType="Todo"/>, document.getElementById('todo'));
		ReactDOM.render(<TaskList dataPass="doing" dataType="Doing"/>,document.getElementById('doing'));
		ReactDOM.render(<TaskList dataPass="done"  dataType="Done"/>, document.getElementById('done'));

		</script>
	</head>
	<body>
		<div id="todo"  class="swimlane"></div>
		<div id="doing" class="swimlane"></div>
		<div id="done"  class="swimlane"></div>
	</body>
</html>
