<html>
	<head>
		<meta charset="utf-8">
		<link rel="stylesheet" href="style.css" type="text/css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react-dom.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
		<script type="text/babel">

		var Task = React.createClass({
			render: function() {
				return (
					<div draggable="true">
						{this.props.dataTaskTitle}
						{this.props.children}
					</div>
				);
			}
		});

		var TaskList = React.createClass({
			createData: function(card_data){
				this.props.onEventCallBackCreate(card_data);
				return;
			},
			deleteData(e){
				var id     = e.currentTarget.getAttribute('id');
				var status = e.currentTarget.getAttribute('data-status');
				this.props.onEventCallBackDelete(id,status);
				return;
			},
			updownData:function(e){
				var id = e.currentTarget.getAttribute('data-id');
				var type = e.currentTarget.getAttribute('data-type');
				var status = e.currentTarget.getAttribute('data-status');
				this.props.onEventCallBack(id,status,type);
				return;
			},
			render: function() {
				let card_create_form = null;
				if (this.props.dataType=="Todo") {
					card_create_form = <CardCreateForm dataType={this.props.dataType} onEventCallBack={this.createData}/>
				}
				return (
					<div className="swimlane" id={this.props.dataType}>
						<h1>{this.props.dataType}</h1>
						<div className="postit">
							{this.props.dataPass.map((data) => {
								return (
									<Task dataTaskTitle={data.title}>
										<input id={data.id} className="delete" type="button" value="☓" onClick={this.deleteData} data-status={data.status}/>
										<input id={"Todo_" + data.id} data-id={data.id} type="button" className="movebutton todobutton"  value="todo" onClick={this.updownData} data-status={data.status} data-type="Todo"/>
										<input id={"Doing_" + data.id} data-id={data.id} type="button" className="movebutton doingbutton" value="doing" onClick={this.updownData} data-status={data.status} data-type="Doing"/>
										<input id={"Done_" + data.id} data-id={data.id} type="button" className="movebutton donebutton" value="done" onClick={this.updownData} data-status={data.status} data-type="Done"/>
									</Task>
								)
							})}
							{card_create_form}
						</div>
					</div>
				);
			}
    });

		var CardCreateForm = React.createClass({
			getInitialState: function(){
				return {
					title: ""
				};
			},
			changeTitle(e) {
				this.setState({title: e.target.value});
			},
			sendCard(event) {
				event.target.title.value="";
				fetch('/tasks', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						title: this.state.title,
						status: this.props.dataType,
					})
				}).then((response) => response.json())
				.then((responseData) => {
					this.props.onEventCallBack({ card_data : responseData });
				})
			},
			render: function() {
				return (
					<div>
						<form action="javascript:void(0)" onSubmit={this.sendCard}>
							<input type="text" id="sendCard" placeholder="Add" name="title" onChange={this.changeTitle} required/>
						</form>
					</div>
				);
			}
		});

		var ListController = React.createClass({
			componentDidMount: function(){
				this.fetchData();
			},
			getInitialState: function(){
				return {
					todos: [],
					doings:[],
					dones:[]
				};
			},
			fetchData: function(){
				fetch("tasks")
				.then((response) => response.json())
				.then((responseData) => {
					this.setState({
						todos: responseData.filter((data) => {
							return data.status == "Todo";
						}),
						doings:responseData.filter((data) => {
							return data.status == "Doing";
						}),
						dones:responseData.filter((data) => {
							return data.status == "Done";
						})
					});
				})
			},
			deleteData(id,status){
				fetch('/tasks/' + id, {method: 'DELETE'})
				.then((responseData) => {
					if(status == "Todo"){
						this.setState({
							todos: this.state.todos.filter((data) => {
								return data.id != id;
							})
						});
					}else if(status == "Doing"){
						this.setState({
							doings: this.state.doings.filter((data) => {
								return data.id != id;
							})
						});
					}else if(status == "Done"){
						this.setState({
							dones: this.state.dones.filter((data) => {
								return data.id != id;
							})
						});
					}
				})
			},
			createData: function(card_data){
				var datas = this.state.todos;
				datas.push(card_data['card_data']);
				this.setState({todos:datas});
			},
			updateData:function(id,status,type){
				var datas = null;

				if(status == "Todo"){
					datas = this.state.todos;
					this.setState({
						todos: datas.filter((data) => {
							return data.id != id;
						})
					});
				}
				if(status == "Doing"){
					datas = this.state.doings;
					this.setState({
						doings: datas.filter((data) => {
							return data.id != id;
						})
					});
				}
				if(status == "Done"){
					datas = this.state.dones;
					this.setState({
						dones: datas.filter((data) => {
							return data.id != id;
						})
					});
				}
				fetch('/tasks/'+id, {
					method: 'PUT',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						status: type,
					})
				})
				.then((response) => response.json())
				.then((responseData) => {
					if(type == "Todo"){
						datas = this.state.todos;
						datas.push(responseData);
						this.setState({todos:datas});
					}else if(type == "Doing"){
						datas = this.state.doings;
						datas.push(responseData);
						this.setState({doings:datas});
					}else if(type == "Done"){
						datas = this.state.dones;
						datas.push(responseData);
						this.setState({dones:datas});
					}
				})
			},
		 	render: function() {
				return (
					<div>
						<TaskList dataPass={this.state.todos}  dataType="Todo"
							onEventCallBack={this.updateData} onEventCallBackDelete={this.deleteData} onEventCallBackCreate={this.createData}/>
						<TaskList dataPass={this.state.doings}  dataType="Doing"
							onEventCallBack={this.updateData} onEventCallBackDelete={this.deleteData} onEventCallBackCreate={this.createData}/>
						<TaskList dataPass={this.state.dones}  dataType="Done"
							onEventCallBack={this.updateData} onEventCallBackDelete={this.deleteData} onEventCallBackCreate={this.createData}/>
					</div>
				);
			}
		});

		ReactDOM.render(<ListController />,document.getElementById('list'))

		</script>

		<script type="text/javascript">
			function onDragstart(e){
				e.dataTransfer.setData('text', e.target.children[0].id);	// ドラッグされた要素のIDをセットしておく
			}

			function onDragOver(e){
				e.preventDefault();
			}

			function onDrop(e){
				fromId = e.dataTransfer.getData('text');
				var dropSwimLane = hitTest(fromId, e.clientX);
				var nowSwimLane = document.getElementById(fromId).getAttribute("data-status")

				if(dropSwimLane == nowSwimLane || dropSwimLane == "Other"){
					e.preventDefault();
					return;
				}

				document.getElementById(dropSwimLane + "_" + fromId).click();
				e.preventDefault();
			}

			// 座標による当たり判定
			function hitTest(id, posX){
				var TODO_POS_X = 90;
				var DOING_POS_X = 570;
				var DONE_POS_X = 1050;
				var WIDTH = 310

				if(posX > TODO_POS_X && posX < (TODO_POS_X + WIDTH)){
					return "Todo";
				}
				if(posX > DOING_POS_X && posX < (DOING_POS_X + WIDTH)){
					return "Doing";
				}
				if(posX > DONE_POS_X && posX < (DONE_POS_X + WIDTH)){
					return "Done";
				}
				return "Other";
			}

			window.onload = function () {
				document.getElementById('Todo').addEventListener('dragstart', onDragstart, false);
				document.getElementById('Doing').addEventListener('dragstart', onDragstart, false);
				document.getElementById('Done').addEventListener('dragstart', onDragstart, false);

				document.getElementById('Todo').addEventListener('dragover', onDragOver, false);
				document.getElementById('Doing').addEventListener('dragover', onDragOver, false);
				document.getElementById('Done').addEventListener('dragover', onDragOver, false);

				document.getElementById('Todo').addEventListener('drop', onDrop, false);
				document.getElementById('Doing').addEventListener('drop', onDrop, false);
				document.getElementById('Done').addEventListener('drop', onDrop, false);
			};
		</script>
	</head>
	<body>
		<div id="list"></div>
	</body>
</html>
